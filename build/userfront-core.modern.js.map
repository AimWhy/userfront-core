{"version":3,"file":"userfront-core.modern.js","sources":["../src/index.js","../src/constants.js"],"sourcesContent":["import axios from \"axios\";\nimport Cookies from \"js-cookie\";\n// import jwt from \"jsonwebtoken\";\n\nimport constants from \"./constants\";\nconst { apiUrl, privateIPRegex } = constants;\n\n/**\n * Determine whether a hostname is in test mode.\n * @param {String} hn\n */\nconst isTestHostname = (hn) => {\n  try {\n    const hostname = hn || window.location.hostname;\n    return !!(hostname.match(/localhost/g) || hostname.match(privateIPRegex));\n  } catch (err) {\n    return true;\n  }\n};\n\nconst store = {\n  mode: isTestHostname() ? \"test\" : \"live\",\n};\n\n/**\n * Initialize the Userfront library.\n * @param {String} tenantId\n */\nfunction init(tenantId) {\n  if (!tenantId) return console.warn(\"Userfront initialized without tenant ID\");\n  store.tenantId = tenantId;\n  store.accessTokenName = `access.${tenantId}`;\n  store.idTokenName = `id.${tenantId}`;\n  store.refreshTokenName = `refresh.${tenantId}`;\n  setTokensFromCookies();\n}\n\n/**\n * Set and then return the access token\n */\nfunction accessToken() {\n  store.accessToken = Cookies.get(store.accessTokenName);\n  return store.accessToken;\n}\n\n/**\n * Set and then return the ID token\n */\nfunction idToken() {\n  store.idToken = Cookies.get(store.idTokenName);\n  return store.idToken;\n}\n\n/**\n * Get the value of a query attribute, e.g. ?attr=value\n * @param {String} attrName\n */\nfunction getQueryAttr(attrName) {\n  if (\n    !window.location.href ||\n    window.location.href.indexOf(`${attrName}=`) < 0\n  ) {\n    return;\n  }\n  return decodeURIComponent(\n    window.location.href.split(`${attrName}=`)[1].split(\"&\")[0]\n  );\n}\n\n/**\n * Define the mode of operation (live or test)\n */\nasync function setMode() {\n  try {\n    const { data } = await axios.get(`${apiUrl}tenants/${store.tenantId}/mode`);\n    store.mode = data.mode || \"test\";\n  } catch (err) {\n    store.mode = \"test\";\n  }\n}\n\n/**\n * Register a new user with username, name, email, and password.\n * Redirect the browser after successful signup based on the redirectTo value returned.\n * @param {*} param0\n */\nasync function signup({ username, name, email, password }) {\n  const { data } = await axios.post(`${apiUrl}auth/create`, {\n    tenantId: store.tenantId,\n    username,\n    name,\n    email,\n    password,\n  });\n\n  if (data.tokens) {\n    setCookiesAndTokens(data.tokens);\n    redirectToPath(getQueryAttr(\"redirect\") || data.redirectTo || \"/\");\n  } else {\n    throw new Error(\"Please try again.\");\n  }\n}\n\n/**\n * Log a user in with email/username and password.\n * Redirect the browser after successful login based on the redirectTo value returned.\n * @param {*} param0\n */\nasync function login({ email, username, emailOrUsername, password }) {\n  const { data } = await axios.post(`${apiUrl}auth/basic`, {\n    tenantId: store.tenantId,\n    emailOrUsername: email || username || emailOrUsername,\n    password,\n  });\n  if (data.tokens) {\n    setCookiesAndTokens(data.tokens);\n    redirectToPath(getQueryAttr(\"redirect\") || data.redirectTo || \"/\");\n  } else {\n    throw new Error(\"Please try again.\");\n  }\n}\n\n/**\n * Log a user in with a token/uuid combo passed into the function or\n * in the URL querystring. ?token=...&uuid=...\n * @param {String} token\n * @param {UUID} uuid\n */\nasync function loginWithTokenAndUuid(token, uuid) {\n  if (!token) token = getQueryAttr(\"token\");\n  if (!uuid) uuid = getQueryAttr(\"uuid\");\n  if (!token || !uuid) return;\n\n  const { data } = await axios.put(`${apiUrl}auth/link`, {\n    token,\n    uuid,\n    tenantId: store.tenantId,\n  });\n\n  if (data.tokens) {\n    setCookiesAndTokens(data.tokens);\n    redirectToPath(getQueryAttr(\"redirect\") || data.redirectTo || \"/\");\n  } else {\n    throw new Error(\"Problem logging in.\");\n  }\n}\n\n/**\n * Send a login link to the provided email.\n * @param {String} email\n */\nasync function sendLoginLink(email) {\n  try {\n    const { data } = await axios.post(`${apiUrl}auth/link`, {\n      email,\n      tenantId: store.tenantId,\n    });\n    return data;\n  } catch (err) {\n    throw new Error(\"Problem sending link\");\n  }\n}\n\n/**\n * Send a password reset link to the provided email.\n * @param {String} email\n */\nasync function sendResetLink(email) {\n  try {\n    const { data } = await axios.post(`${apiUrl}auth/reset/link`, {\n      email,\n      tenantId: store.tenantId,\n    });\n    return data;\n  } catch (err) {\n    throw new Error(\"Problem sending link\");\n  }\n}\n\nasync function resetPassword({ uuid, token, password }) {\n  if (!token) token = getQueryAttr(\"token\");\n  if (!uuid) uuid = getQueryAttr(\"uuid\");\n  if (!token || !uuid) throw new Error(\"Missing token or uuid\");\n  const { data } = await axios.put(`${apiUrl}auth/reset`, {\n    tenantId: store.tenantId,\n    uuid,\n    token,\n    password,\n  });\n  if (data.tokens) {\n    setCookiesAndTokens(data.tokens);\n    redirectToPath(getQueryAttr(\"redirect\") || data.redirectTo || \"/\");\n  } else {\n    throw new Error(\n      \"There was a problem resetting your password. Please try again.\"\n    );\n  }\n}\n\n// TODO replace with direct check of the access token.\n/**\n * If the access token is valid, redirect the browser to the\n * tenant's login redirection path (path after login).\n */\nasync function redirectIfLoggedIn() {\n  if (!store.accessToken) return removeAllCookies();\n  try {\n    const { data } = await axios.get(`${apiUrl}self`, {\n      headers: {\n        authorization: `Bearer ${store.accessToken}`,\n      },\n    });\n    if (data.tenant && data.tenant.loginRedirectPath) {\n      redirectToPath(data.tenant.loginRedirectPath);\n    }\n  } catch (err) {\n    removeAllCookies();\n  }\n}\n\n/**\n * Redirect to path portion of a URL.\n */\nfunction redirectToPath(pathOrUrl) {\n  if (!pathOrUrl) return;\n  const el = document.createElement(\"a\");\n  el.href = pathOrUrl;\n  let path = `${el.pathname}${el.hash}${el.search}`;\n  if (el.pathname !== window.location.pathname) {\n    window.location.href = path;\n  }\n}\n\n/**\n * Log a user out and redirect to the logout path.\n */\nasync function logout() {\n  if (!store.accessToken) return removeAllCookies();\n  try {\n    const { data } = await axios.get(`${apiUrl}auth/logout`, {\n      headers: {\n        authorization: `Bearer ${store.accessToken}`,\n      },\n    });\n    removeAllCookies();\n    redirectToPath(data.redirectTo);\n  } catch (err) {}\n}\n\n/**\n * Set a cookie value based on the given options.\n * @param {String} value\n * @param {Object} options\n * @param {String} type\n */\nfunction setCookie(value, options, type) {\n  const cookieName = `${type}.${store.tenantId}`;\n  options = options || {\n    secure: store.mode === \"live\",\n    sameSite: \"Lax\",\n  };\n  if (type === \"refresh\") {\n    options.sameSite = \"Strict\";\n  }\n  Cookies.set(cookieName, value, options);\n}\n\n/**\n * Remove a cookie by name, regardless of its cookie setting(s).\n * @param {String} name\n */\nfunction removeCookie(name) {\n  Cookies.remove(name);\n  Cookies.remove(name, { secure: true, sameSite: \"Lax\" });\n  Cookies.remove(name, { secure: true, sameSite: \"None\" });\n  Cookies.remove(name, { secure: false, sameSite: \"Lax\" });\n  Cookies.remove(name, { secure: false, sameSite: \"None\" });\n}\n\n/**\n * Remove all auth cookies (access, id, refresh).\n */\nfunction removeAllCookies() {\n  removeCookie(store.accessTokenName);\n  removeCookie(store.idTokenName);\n  removeCookie(store.refreshTokenName);\n  store.accessToken = undefined;\n  store.idToken = undefined;\n  store.refreshToken = undefined;\n}\n\n/**\n * Define the store token values from the cookie values.\n */\nfunction setTokensFromCookies() {\n  store.accessToken = Cookies.get(store.accessTokenName);\n  store.idToken = Cookies.get(store.idTokenName);\n  store.refreshToken = Cookies.get(store.refreshTokenName);\n}\n\n/**\n * Set the cookies from a tokens object, and add to the local store.\n * @param {Object} tokens\n */\nfunction setCookiesAndTokens(tokens) {\n  setCookie(tokens.access.value, tokens.access.cookieOptions, \"access\");\n  setCookie(tokens.id.value, tokens.id.cookieOptions, \"id\");\n  setCookie(tokens.refresh.value, tokens.refresh.cookieOptions, \"refresh\");\n  setTokensFromCookies();\n}\n\nexport default {\n  accessToken,\n  getQueryAttr,\n  idToken,\n  init,\n  isTestHostname,\n  login,\n  loginWithTokenAndUuid,\n  logout,\n  redirectIfLoggedIn,\n  resetPassword,\n  sendLoginLink,\n  sendResetLink,\n  setMode,\n  setCookie,\n  signup,\n  store,\n};\n","export default {\n  apiUrl: `https://api.userfront.com/v0/`,\n  privateIPRegex: /((^127\\.)|(^10\\.)|(^172\\.1[6-9]\\.)|(^172\\.2[0-9]\\.)|(^172\\.3[0-1]\\.)|(^192\\.168\\.))\\d{1,3}\\.\\d{1,3}/g,\n};\n"],"names":["apiUrl","privateIPRegex","isTestHostname","hn","hostname","window","location","match","err","store","mode","getQueryAttr","attrName","href","indexOf","decodeURIComponent","split","redirectToPath","pathOrUrl","el","document","createElement","pathname","hash","search","setCookie","value","options","type","cookieName","tenantId","secure","sameSite","Cookies","set","removeCookie","name","remove","removeAllCookies","accessTokenName","idTokenName","refreshTokenName","accessToken","undefined","idToken","refreshToken","setTokensFromCookies","get","setCookiesAndTokens","tokens","access","cookieOptions","id","refresh","init","console","warn","login","async","email","username","emailOrUsername","password","data","axios","post","Error","redirectTo","loginWithTokenAndUuid","token","uuid","put","logout","headers","authorization","redirectIfLoggedIn","tenant","loginRedirectPath","resetPassword","sendLoginLink","sendResetLink","setMode","signup"],"mappings":"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"}